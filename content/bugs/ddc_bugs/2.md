[title=DDC: Marisa's Lasers]
# Marisa's Lasers

[repeatDuplicate] [bugUninitialisedVariable]
[hr]
## [specs]

* **Versions**: [yes]1.00a[/yes] - [yes]1.00b[/yes]
* **Difficullty**: [yes]Easy[/yes] - [yes]Normal[/yes] - [yes]Hard[/yes] - [yes]Lunatic[/yes] - [yes]Extra[/yes]
* **Mode**: [yes]Main game[/yes] -  [yes]Practice mode[/yes] - [yes]Spell practice[/yes]
* **Shottype**: [no]ReimuA[/no] - [no]ReimuB[/no] - [yes]MarisaA[/yes] - [yes]MarisaB[/yes] - [no]SakuyaA[/no] - [no]SakuyaB[/no]

## [what]

Marisa's laser(s) bugs out. It may burnout, it may be set at a 45° angle, it may hit an enemy from the opposite end of the screen. 

[img=content/bugs/ddc_bugs/2_comparison.png] [br]
## [how]

Marisa's laser(s) rarely bug out when it comes in contact with an enemy. 

## [why]

The code for Marisa's lasers is as follows:

[code] // Code is manually copied from https://www.bilibili.com/read/cv5915344
v7 = a1;
v8 = a2;
v33 = a1[42] == 0;
a1[41] = 1;
if ( v33 )
{ 
    sub_47F140(a1[5], 2);
    *(v7 + 42) = 1;
}
if ( !a3 )
{
    v44 = (*(*(v7 + 48) + 40) * 0.5) + a5;
    v9 = *v8 - v7[21];
    *&v45 = *(v8 + 1) - v7[22];
    v10 = _mm_xor_ps(*(v7 + 28), xmmword_4C1D10);
    v11 = v10.m128i_i32[0];
    *v10.m128i_i64 = *v10.m128i_i32;
    v12 = _libm_sse_sin_precise(v10, xmm1_0, xmm4_0);
    *v12.m128i_i32 = *v12.m128i_i64;
    v47 = *v12.m128i_i32;
    v13 = _libm_sse2_cos_precise(_mm_cvtps_pd(v11), xmm1_0, xmm4_0);
    v14 = v13.m128d_f64[0];
    v15 = (*&v45 * v14) + (v9 * v47);
    v16 = (v14 * v9) - (*&v45 * v47);
    v47 = (v14 * v9) - (*&v45 * v47);
    \*v13.m128d_f64 = COERCE_DOUBLE(*&v15 & xmmword_4C1D00);
    if ( *v13.m128d_f64 > f44 || COERCE_FLOAT(LODWORD(v44) ^ xmmword_4C1D10) > 16 || v16 < 0.0 && ((v16 * v16) + (v15 * v15)) > (v44 * v44) )
    {
        v19 = v48; // This line causes problems.
    }
    else
    {
        v17 = 0x3F800000u;
        v17.m128_f32[0] = 1.0 - ((v15 / v44) * (v15 / v44));
        v18 = _libm_sse_sqrt_precise(_mm_cvtps_pd(v17));
        *v18.m128i_i32 = * v18.m128i_i64;
        v19 = v47 - (*v18.m128i_i32 * v44);
    }
    v20 = v19 + 8,0;
    v7[44] = v20; // Set Length
    if ( v20 < 0.0 )
        v7[44] = 0.0;
    *(*(v7 + 48) + 36) = v7[44];
LABEL_28:
    v22 = (v7 + 21);
    goto LABEL_29;
}
[/code]

In the line ``v19 = v48;`` the value of ``v19`` is set to the value of ``v48``. However, ``v48`` is never declared in this scope. ``v48`` is an uninitialised variable and so is ``v19``. ``v19`` is partly responsible for the length of the laser. Because ``v19`` is also an uninitialised variable this means the length of Marisa's lasers may bug out.

In terms of why it happens very inceconsistently it has to do with numerous factors; your operating system being one of them from what I have been told.

[hr]
## [links]

### [rpy]

### [vid]
+ ack7139. (2020, May 4). "\[教程向\] 激光折了怎么办？辉针城魔理沙rep爆炸修复与预防". [a=https://www.bilibili.com/video/BV1vf4y1m7Ue]https://www.bilibili.com/video/BV1vf4y1m7Ue[/a]
+ Plus. (2020, February 22). "【バグ】東方輝針城 魔理沙/Aのリプレイ". [a=https://youtu.be/RBqaFcZPdpw]https://youtu.be/RBqaFcZPdpw[/a]

### [misc]
+ ack7139. (2020, May 4). "最简单的bug，最迷惑的效果——辉针城魔理沙激光bug初步解析". [a=https://www.bilibili.com/read/cv5915344]https://www.bilibili.com/read/cv5915344[/a]

### [patches]
+ ack7139. "thprac". [a=https://github.com/ack7139/thprac/releases]https://github.com/ack7139/thprac/releases[/a]

